name: å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²
on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨å®˜æ–¹æ’ä»¶å®‰è£… Node.js 18
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3. éªŒè¯ç¯å¢ƒå¹¶æ‰“åŒ…
      - name: Install & Build
        run: |
          echo "å½“å‰ Node ç‰ˆæœ¬:"
          node -v
          echo "å½“å‰ NPM ç‰ˆæœ¬:"
          npm -v

          # è®¾ç½®æ·˜å®æºåŠ é€Ÿ
          npm config set registry https://registry.npmmirror.com

          # å®‰è£…ä¾èµ–
          npm install

          # æ‰“åŒ…
          npm run build

          # éªŒè¯äº§ç‰©
          ls -la dist/

      # 4. ä¿®å¤ï¼šä¼ è¾“æ–‡ä»¶ (ä½¿ç”¨ scp-action)
      - name: Copy files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SERVER_SSH_KEY }}
          # å°†æœ¬åœ° dist ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°æœåŠ¡å™¨æŒ‡å®šç›®å½•
          # strip_components: 1 è¡¨ç¤ºå»æ‰ dist è¿™ä¸€å±‚æ–‡ä»¶å¤¹ï¼Œç›´æ¥æŠŠå†…å®¹æ‹·è¿›å»
          source: 'dist/*'
          target: '/var/www/html/vue-admin-template/'
          strip_components: 1

      # 5. ä¿®å¤ï¼šè¿œç¨‹æ‰§è¡Œå‘½ä»¤ (ä½¿ç”¨ ssh-action)
      - name: Restart Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SERVER_SSH_KEY }}
          script: |
            echo "æ–‡ä»¶ä¼ è¾“å®Œæˆï¼Œæ£€æŸ¥ç›®å½•..."
            ls -la /var/www/html/vue-admin-template/

            # è®¾ç½®æƒé™
            sudo chown -R www-data:www-data /var/www/html/vue-admin-template/
            sudo chmod -R 755 /var/www/html/vue-admin-template/

            # é‡å¯ Nginx (å¦‚æœåªæ˜¯é™æ€æ–‡ä»¶æ›´æ–°ï¼Œå…¶å®ä¸éœ€è¦é‡å¯nginxï¼Œä½†é‡å¯ä¹Ÿæ²¡äº‹)
            # å»ºè®®ä½¿ç”¨ reload è€Œä¸æ˜¯ restartï¼Œé¿å…æœåŠ¡ä¸­æ–­
            sudo systemctl reload nginx
            echo "ğŸš€ éƒ¨ç½²æˆåŠŸ!"
