import{q as fe,_ as ce,h as b,c as Q,m as de,r as C,a as j,o as S,e as f,w as v,b as K,s as T,v as P,f as z,t as H,x as he,E,y as O}from"./index-B9wvQeQm.js";var X={exports:{}},ee;function pe(){return ee||(ee=1,(function(Y,w){(function(B){Y.exports=B()})(function(B){var M=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function y(n,r){var t=n[0],e=n[1],l=n[2],a=n[3];t+=(e&l|~e&a)+r[0]-680876936|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&l)+r[1]-389564586|0,a=(a<<12|a>>>20)+t|0,l+=(a&t|~a&e)+r[2]+606105819|0,l=(l<<17|l>>>15)+a|0,e+=(l&a|~l&t)+r[3]-1044525330|0,e=(e<<22|e>>>10)+l|0,t+=(e&l|~e&a)+r[4]-176418897|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&l)+r[5]+1200080426|0,a=(a<<12|a>>>20)+t|0,l+=(a&t|~a&e)+r[6]-1473231341|0,l=(l<<17|l>>>15)+a|0,e+=(l&a|~l&t)+r[7]-45705983|0,e=(e<<22|e>>>10)+l|0,t+=(e&l|~e&a)+r[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&l)+r[9]-1958414417|0,a=(a<<12|a>>>20)+t|0,l+=(a&t|~a&e)+r[10]-42063|0,l=(l<<17|l>>>15)+a|0,e+=(l&a|~l&t)+r[11]-1990404162|0,e=(e<<22|e>>>10)+l|0,t+=(e&l|~e&a)+r[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&l)+r[13]-40341101|0,a=(a<<12|a>>>20)+t|0,l+=(a&t|~a&e)+r[14]-1502002290|0,l=(l<<17|l>>>15)+a|0,e+=(l&a|~l&t)+r[15]+1236535329|0,e=(e<<22|e>>>10)+l|0,t+=(e&a|l&~a)+r[1]-165796510|0,t=(t<<5|t>>>27)+e|0,a+=(t&l|e&~l)+r[6]-1069501632|0,a=(a<<9|a>>>23)+t|0,l+=(a&e|t&~e)+r[11]+643717713|0,l=(l<<14|l>>>18)+a|0,e+=(l&t|a&~t)+r[0]-373897302|0,e=(e<<20|e>>>12)+l|0,t+=(e&a|l&~a)+r[5]-701558691|0,t=(t<<5|t>>>27)+e|0,a+=(t&l|e&~l)+r[10]+38016083|0,a=(a<<9|a>>>23)+t|0,l+=(a&e|t&~e)+r[15]-660478335|0,l=(l<<14|l>>>18)+a|0,e+=(l&t|a&~t)+r[4]-405537848|0,e=(e<<20|e>>>12)+l|0,t+=(e&a|l&~a)+r[9]+568446438|0,t=(t<<5|t>>>27)+e|0,a+=(t&l|e&~l)+r[14]-1019803690|0,a=(a<<9|a>>>23)+t|0,l+=(a&e|t&~e)+r[3]-187363961|0,l=(l<<14|l>>>18)+a|0,e+=(l&t|a&~t)+r[8]+1163531501|0,e=(e<<20|e>>>12)+l|0,t+=(e&a|l&~a)+r[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,a+=(t&l|e&~l)+r[2]-51403784|0,a=(a<<9|a>>>23)+t|0,l+=(a&e|t&~e)+r[7]+1735328473|0,l=(l<<14|l>>>18)+a|0,e+=(l&t|a&~t)+r[12]-1926607734|0,e=(e<<20|e>>>12)+l|0,t+=(e^l^a)+r[5]-378558|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^l)+r[8]-2022574463|0,a=(a<<11|a>>>21)+t|0,l+=(a^t^e)+r[11]+1839030562|0,l=(l<<16|l>>>16)+a|0,e+=(l^a^t)+r[14]-35309556|0,e=(e<<23|e>>>9)+l|0,t+=(e^l^a)+r[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^l)+r[4]+1272893353|0,a=(a<<11|a>>>21)+t|0,l+=(a^t^e)+r[7]-155497632|0,l=(l<<16|l>>>16)+a|0,e+=(l^a^t)+r[10]-1094730640|0,e=(e<<23|e>>>9)+l|0,t+=(e^l^a)+r[13]+681279174|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^l)+r[0]-358537222|0,a=(a<<11|a>>>21)+t|0,l+=(a^t^e)+r[3]-722521979|0,l=(l<<16|l>>>16)+a|0,e+=(l^a^t)+r[6]+76029189|0,e=(e<<23|e>>>9)+l|0,t+=(e^l^a)+r[9]-640364487|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^l)+r[12]-421815835|0,a=(a<<11|a>>>21)+t|0,l+=(a^t^e)+r[15]+530742520|0,l=(l<<16|l>>>16)+a|0,e+=(l^a^t)+r[2]-995338651|0,e=(e<<23|e>>>9)+l|0,t+=(l^(e|~a))+r[0]-198630844|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~l))+r[7]+1126891415|0,a=(a<<10|a>>>22)+t|0,l+=(t^(a|~e))+r[14]-1416354905|0,l=(l<<15|l>>>17)+a|0,e+=(a^(l|~t))+r[5]-57434055|0,e=(e<<21|e>>>11)+l|0,t+=(l^(e|~a))+r[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~l))+r[3]-1894986606|0,a=(a<<10|a>>>22)+t|0,l+=(t^(a|~e))+r[10]-1051523|0,l=(l<<15|l>>>17)+a|0,e+=(a^(l|~t))+r[1]-2054922799|0,e=(e<<21|e>>>11)+l|0,t+=(l^(e|~a))+r[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~l))+r[15]-30611744|0,a=(a<<10|a>>>22)+t|0,l+=(t^(a|~e))+r[6]-1560198380|0,l=(l<<15|l>>>17)+a|0,e+=(a^(l|~t))+r[13]+1309151649|0,e=(e<<21|e>>>11)+l|0,t+=(l^(e|~a))+r[4]-145523070|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~l))+r[11]-1120210379|0,a=(a<<10|a>>>22)+t|0,l+=(t^(a|~e))+r[2]+718787259|0,l=(l<<15|l>>>17)+a|0,e+=(a^(l|~t))+r[9]-343485551|0,e=(e<<21|e>>>11)+l|0,n[0]=t+n[0]|0,n[1]=e+n[1]|0,n[2]=l+n[2]|0,n[3]=a+n[3]|0}function U(n){var r=[],t;for(t=0;t<64;t+=4)r[t>>2]=n.charCodeAt(t)+(n.charCodeAt(t+1)<<8)+(n.charCodeAt(t+2)<<16)+(n.charCodeAt(t+3)<<24);return r}function I(n){var r=[],t;for(t=0;t<64;t+=4)r[t>>2]=n[t]+(n[t+1]<<8)+(n[t+2]<<16)+(n[t+3]<<24);return r}function V(n){var r=n.length,t=[1732584193,-271733879,-1732584194,271733878],e,l,a,p,x,N;for(e=64;e<=r;e+=64)y(t,U(n.substring(e-64,e)));for(n=n.substring(e-64),l=n.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<l;e+=1)a[e>>2]|=n.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(y(t,a),e=0;e<16;e+=1)a[e]=0;return p=r*8,p=p.toString(16).match(/(.*?)(.{0,8})$/),x=parseInt(p[2],16),N=parseInt(p[1],16)||0,a[14]=x,a[15]=N,y(t,a),t}function d(n){var r=n.length,t=[1732584193,-271733879,-1732584194,271733878],e,l,a,p,x,N;for(e=64;e<=r;e+=64)y(t,I(n.subarray(e-64,e)));for(n=e-64<r?n.subarray(e-64):new Uint8Array(0),l=n.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<l;e+=1)a[e>>2]|=n[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(y(t,a),e=0;e<16;e+=1)a[e]=0;return p=r*8,p=p.toString(16).match(/(.*?)(.{0,8})$/),x=parseInt(p[2],16),N=parseInt(p[1],16)||0,a[14]=x,a[15]=N,y(t,a),t}function _(n){var r="",t;for(t=0;t<4;t+=1)r+=M[n>>t*8+4&15]+M[n>>t*8&15];return r}function h(n){var r;for(r=0;r<n.length;r+=1)n[r]=_(n[r]);return n.join("")}h(V("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&(function(){function n(r,t){return r=r|0||0,r<0?Math.max(r+t,0):Math.min(r,t)}ArrayBuffer.prototype.slice=function(r,t){var e=this.byteLength,l=n(r,e),a=e,p,x,N,q;return t!==B&&(a=n(t,e)),l>a?new ArrayBuffer(0):(p=a-l,x=new ArrayBuffer(p),N=new Uint8Array(x),q=new Uint8Array(this,l,p),N.set(q),x)}})();function g(n){return/[\u0080-\uFFFF]/.test(n)&&(n=unescape(encodeURIComponent(n))),n}function $(n,r){var t=n.length,e=new ArrayBuffer(t),l=new Uint8Array(e),a;for(a=0;a<t;a+=1)l[a]=n.charCodeAt(a);return r?l:e}function F(n){return String.fromCharCode.apply(null,new Uint8Array(n))}function L(n,r,t){var e=new Uint8Array(n.byteLength+r.byteLength);return e.set(new Uint8Array(n)),e.set(new Uint8Array(r),n.byteLength),e}function A(n){var r=[],t=n.length,e;for(e=0;e<t-1;e+=2)r.push(parseInt(n.substr(e,2),16));return String.fromCharCode.apply(String,r)}function o(){this.reset()}return o.prototype.append=function(n){return this.appendBinary(g(n)),this},o.prototype.appendBinary=function(n){this._buff+=n,this._length+=n.length;var r=this._buff.length,t;for(t=64;t<=r;t+=64)y(this._hash,U(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},o.prototype.end=function(n){var r=this._buff,t=r.length,e,l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a;for(e=0;e<t;e+=1)l[e>>2]|=r.charCodeAt(e)<<(e%4<<3);return this._finish(l,t),a=h(this._hash),n&&(a=A(a)),this.reset(),a},o.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},o.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},o.prototype.setState=function(n){return this._buff=n.buff,this._length=n.length,this._hash=n.hash,this},o.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},o.prototype._finish=function(n,r){var t=r,e,l,a;if(n[t>>2]|=128<<(t%4<<3),t>55)for(y(this._hash,n),t=0;t<16;t+=1)n[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),l=parseInt(e[2],16),a=parseInt(e[1],16)||0,n[14]=l,n[15]=a,y(this._hash,n)},o.hash=function(n,r){return o.hashBinary(g(n),r)},o.hashBinary=function(n,r){var t=V(n),e=h(t);return r?A(e):e},o.ArrayBuffer=function(){this.reset()},o.ArrayBuffer.prototype.append=function(n){var r=L(this._buff.buffer,n),t=r.length,e;for(this._length+=n.byteLength,e=64;e<=t;e+=64)y(this._hash,I(r.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(r.buffer.slice(e-64)):new Uint8Array(0),this},o.ArrayBuffer.prototype.end=function(n){var r=this._buff,t=r.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l,a;for(l=0;l<t;l+=1)e[l>>2]|=r[l]<<(l%4<<3);return this._finish(e,t),a=h(this._hash),n&&(a=A(a)),this.reset(),a},o.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},o.ArrayBuffer.prototype.getState=function(){var n=o.prototype.getState.call(this);return n.buff=F(n.buff),n},o.ArrayBuffer.prototype.setState=function(n){return n.buff=$(n.buff,!0),o.prototype.setState.call(this,n)},o.ArrayBuffer.prototype.destroy=o.prototype.destroy,o.ArrayBuffer.prototype._finish=o.prototype._finish,o.ArrayBuffer.hash=function(n,r){var t=d(new Uint8Array(n)),e=h(t);return r?A(e):e},o})})(X)),X.exports}var ve=pe();const ye=fe(ve),_e={class:"video-upload-container"},ge={key:0,class:"upload-placeholder"},me={key:1,class:"file-info"},be={class:"file-header"},Ae={class:"file-meta"},Ce={key:1,class:"progress-info"},we={key:0},Be={class:"upload-controls"},te=5*1024*1024,Ue={__name:"uploadVideo",setup(Y){const w=b(null),B=b(""),M=b([]),y=b(!1),U=b(0),I=b(0),V=b(0),d=b(!1),_=b(!1),h=b(!1),g=b(""),$=b(""),F=b([]),L=b(0),A=b(null),o=Q(()=>F.value.length>0),n=u=>u.type.startsWith("video/")?!0:(E.error("请选择视频文件（支持MP4、MOV等格式）"),!1),r=u=>{const s=u.raw;W(),w.value=s,V.value=s.size,t(s)},t=u=>{const s=[];let c=0;for(;c<u.size;){const i=Math.min(c+te,u.size);s.push({file:u.slice(c,i),index:s.length,size:i-c}),c=i}M.value=s,e(u,s)},e=(u,s)=>{y.value=!0;const c=new ye.ArrayBuffer,i=new FileReader;let m=0;const R=()=>{const D=s[m].file;i.readAsArrayBuffer(D)};i.onload=D=>{c.append(D.target.result),m++,m<s.length?R():(B.value=c.end(),y.value=!1,l())},i.onerror=()=>{y.value=!1,g.value="计算文件哈希失败，请重试",console.error("文件哈希计算错误:",i.error)},R()},l=async()=>{if(!(!B.value||!w.value))try{const u=await O.post("http://localhost:3009/upload/upload/check-chunks",{fileHash:B.value,fileName:w.value.name});if(u.data.success){if(u.data.fileExists){h.value=!0,U.value=100,$.value=u.data.fileUrl,E.success("文件已上传完成");return}F.value=u.data.uploadedChunks||[],L.value=F.value.length>0?Math.max(...F.value)+1:0,I.value=F.value.reduce((s,c)=>{const i=M.value.find(m=>m.index===c);return s+(i?i.size:te)},0),U.value=V.value?Math.min(I.value/V.value*100,100):0}}catch(u){g.value="检查上传进度失败："+(u.response?.data?.message||u.message),console.error("检查上传进度错误:",u)}},a=async()=>{!w.value||!B.value||d.value||(d.value=!0,_.value=!1,g.value="",await p())},p=async()=>{if(L.value>=M.value.length){await ae();return}if(F.value.includes(L.value))return L.value++,p();const u=M.value[L.value],s=new FormData;s.append("fileHash",B.value),s.append("fileName",w.value.name),s.append("chunkIndex",u.index),s.append("chunk",u.file),A.value=new AbortController;try{const c=await O.post("http://localhost:3009/upload/upload/upload-chunk",s,{headers:{"Content-Type":"multipart/form-data"},signal:A.value.signal,onUploadProgress:i=>{if(i.lengthComputable&&d.value){const m=i.loaded,R=I.value+m;U.value=Math.min(R/V.value*100,100)}}});c.data.success?(F.value.push(u.index),I.value+=u.size,U.value=Math.min(I.value/V.value*100,100),L.value++,p()):(g.value=c.data.message||"分片上传失败",d.value=!1,_.value=!0)}catch(c){c.name!=="AbortError"&&(g.value="上传失败："+(c.response?.data?.message||c.message),console.error("分片上传错误:",c)),d.value=!1,_.value=!0}},x=()=>{A.value&&A.value.abort(),d.value=!1,_.value=!0,E.info("上传已暂停")},N=()=>{L.value<M.value.length&&(d.value=!0,_.value=!1,E.info("继续上传"),p())},q=async()=>{if(A.value&&A.value.abort(),o.value)try{await O.post("http://localhost:3009/upload/upload/cancel-upload",{fileHash:B.value,deleteChunks:!1}),E.success("已取消上传，分片已保留")}catch(u){console.error("取消上传错误:",u),E.error("取消上传失败")}else E.success("已取消上传");W()},ae=async()=>{try{const u=await O.post("http://localhost:3009/upload/upload/merge-chunks",{fileHash:B.value,fileName:w.value.name,totalChunks:M.value.length});u.data.success?(h.value=!0,U.value=100,$.value=u.data.fileUrl,E.success("文件上传完成")):g.value=u.data.message||"文件合并失败"}catch(u){g.value="文件合并失败："+(u.response?.data?.message||u.message),console.error("合并分片错误:",u)}finally{d.value=!1}},W=()=>{w.value=null,B.value="",M.value=[],y.value=!1,U.value=0,I.value=0,V.value=0,d.value=!1,_.value=!1,h.value=!1,g.value="",$.value="",F.value=[],L.value=0,A.value&&(A.value.abort(),A.value=null)},J=u=>{if(u===0)return"0 Bytes";const s=1024,c=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(u)/Math.log(s));return parseFloat((u/Math.pow(s,i)).toFixed(2))+" "+c[i]},G=Q(()=>h.value?"success":g.value?"exception":_.value?"warning":d.value?"processing":""),le=Q(()=>h.value?"上传成功":_.value?"上传已暂停":"");return de(()=>{}),(u,s)=>{const c=C("UploadFilled"),i=C("el-icon"),m=C("el-text"),R=C("VideoFilled"),D=C("el-button"),re=C("el-progress"),ne=C("LoadingFilled"),se=C("el-upload"),Z=C("PlayFilled"),ue=C("PauseFilled"),oe=C("CloseFilled"),k=C("el-alert"),ie=C("el-card");return S(),j("div",_e,[f(ie,{title:"视频分片上传",class:"upload-card"},{default:v(()=>[f(se,{class:"upload-area",action:"","show-file-list":!1,"before-upload":n,"on-change":r,"auto-upload":!1},{default:v(()=>[w.value?P("",!0):(S(),j("div",ge,[f(i,{class:"upload-icon"},{default:v(()=>[f(c)]),_:1}),s[2]||(s[2]=K("div",{class:"upload-text"},"点击或拖拽视频文件到此处上传",-1)),f(m,{size:"small",type:"info"},{default:v(()=>[...s[1]||(s[1]=[z("支持断点续传，最大支持GB级文件",-1)])]),_:1})])),w.value?(S(),j("div",me,[K("div",be,[f(i,{class:"file-icon"},{default:v(()=>[f(R)]),_:1}),K("div",Ae,[f(m,{strong:""},{default:v(()=>[z(H(w.value.name),1)]),_:1}),f(m,{type:"secondary",size:"small"},{default:v(()=>[z(H(J(w.value.size)),1)]),_:1})]),f(D,{icon:"Delete",size:"small",type:"text",onClick:W,circle:""})]),d.value||_.value||h.value?(S(),T(re,{key:0,percentage:U.value,status:G.value,"stroke-width":6,class:"upload-progress"},null,8,["percentage","status"])):P("",!0),d.value||_.value||h.value?(S(),j("div",Ce,[f(m,{size:"small"},{default:v(()=>[z(H(U.value.toFixed(1))+"% ",1),d.value?(S(),j("span",we,"("+H(J(I.value))+" / "+H(J(V.value))+")",1)):P("",!0)]),_:1}),G.value==="success"||G.value==="warning"?(S(),T(m,{key:0,size:"small",type:G.value==="success"?"success":"warning"},{default:v(()=>[z(H(le.value),1)]),_:1},8,["type"])):P("",!0)])):P("",!0),y.value&&!d.value&&!_.value&&!h.value?(S(),T(m,{key:2,size:"small",type:"info"},{default:v(()=>[f(i,null,{default:v(()=>[f(ne)]),_:1}),s[3]||(s[3]=z(" 正在计算文件哈希，准备上传... ",-1))]),_:1})):P("",!0),o.value&&!d.value&&!_.value&&!h.value&&!y.value?(S(),T(m,{key:3,size:"small",type:"info"},{default:v(()=>[z(" 发现已上传 "+H(F.value.length)+" 个分片，点击「开始上传」继续 ",1)]),_:1})):P("",!0)])):P("",!0)]),_:1}),K("div",Be,[f(D,{onClick:he(a,["stop"]),disabled:d.value||h.value||_.value||y.value,type:"primary",size:"small"},{default:v(()=>[f(i,null,{default:v(()=>[f(Z)]),_:1}),s[4]||(s[4]=z(" 开始上传 ",-1))]),_:1},8,["disabled"]),f(D,{onClick:x,disabled:!d.value||_.value||h.value,type:"warning",size:"small"},{default:v(()=>[f(i,null,{default:v(()=>[f(ue)]),_:1}),s[5]||(s[5]=z(" 暂停 ",-1))]),_:1},8,["disabled"]),f(D,{onClick:N,disabled:!_.value||d.value||h.value,type:"success",size:"small"},{default:v(()=>[f(i,null,{default:v(()=>[f(Z)]),_:1}),s[6]||(s[6]=z(" 继续 ",-1))]),_:1},8,["disabled"]),f(D,{onClick:q,disabled:!d.value&&!_.value&&!h.value&&!o.value,type:"danger",size:"small"},{default:v(()=>[f(i,null,{default:v(()=>[f(oe)]),_:1}),s[7]||(s[7]=z(" 取消 ",-1))]),_:1},8,["disabled"])]),h.value?(S(),T(k,{key:0,title:"上传完成",description:`视频已成功上传，URL: ${$.value}`,type:"success","show-icon":"",class:"success-alert"},null,8,["description"])):P("",!0),g.value?(S(),T(k,{key:1,title:g.value,type:"error","show-icon":"",closable:"",onClose:s[0]||(s[0]=Fe=>g.value=""),class:"error-alert"},null,8,["title"])):P("",!0)]),_:1})])}}},Se=ce(Ue,[["__scopeId","data-v-bd669413"]]);export{Se as default};
