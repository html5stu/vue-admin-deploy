import{g as oe,u as ae,c as se,a as ne,d as ie,b as re,e as de}from"./role-v-pRJHd9.js";import{g as ue,h as _,l as C,m as me,r,z as pe,a as ce,o as B,b as m,e as l,w as a,f as u,A as fe,s as ge,t as K,E as h,F as D,J as ve,K as _e,_ as be}from"./index-B9wvQeQm.js";const ye={class:"p-6 animate-fade-in"},xe={class:"bg-white p-5 rounded-xl shadow-sm mb-4"},he={class:"flex justify-between items-center"},Ve={class:"bg-white p-5 rounded-xl shadow-sm min-h-[600px] flex flex-col"},ke={class:"font-medium text-slate-700"},Ce={class:"mt-auto pt-4 flex justify-end"},Ne={class:"dialog-footer"},we={class:"h-full flex flex-col"},Ke={class:"mb-4 p-3 bg-blue-50 text-blue-600 rounded-lg text-sm"},Re={class:"flex-1 overflow-auto border rounded-lg p-2"},Se={class:"mt-4 flex justify-end gap-3"},Ue=ue({name:"Role",__name:"role",setup(ze){const N=_(!1),R=_(0),b=_(),V=_(),p=C({pageNum:1,pageSize:10,roleName:"",status:void 0}),S=_([]),f=C({visible:!1,title:""}),d=C({visible:!1,loading:!1,roleId:0,roleName:""}),s=C({id:0,roleName:"",roleKey:"",sort:0,status:1,remark:""}),E={roleName:[{required:!0,message:"请输入角色名称",trigger:"blur"}],roleKey:[{required:!0,message:"请输入权限字符",trigger:"blur"}]},w=_([]),v=()=>{N.value=!0,oe(p).then(t=>{S.value=t.data.list,R.value=t.data.total}).catch(t=>{h.error("获取角色列表失败"),console.error(t)}).finally(()=>{N.value=!1})},k=()=>v(),P=()=>{p.roleName="",p.status=void 0,k()},U=()=>{s.id=0,s.roleName="",s.roleKey="",s.sort=0,s.status=1,s.remark="",b.value&&b.value.resetFields()},F=()=>{U(),f.title="新增角色",f.visible=!0},M=t=>{U(),Object.assign(s,JSON.parse(JSON.stringify(t))),f.title="编辑角色",f.visible=!0},j=async()=>{if(b.value)try{await b.value.validate(),await(s.id?ae(s):se(s)),h.success(s.id?"修改成功":"新增成功"),f.visible=!1,v()}catch(t){console.error("表单验证失败或提交失败:",t)}},q=t=>{console.log("row",t.status);const e=t.status===1?"启用":"停用";D.confirm(`确认要${e} "${t.roleName}" 角色吗?`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ne({id:t.id,status:t.status}).then(()=>{h.success(`${e}成功`),v()}).catch(n=>{t.status=t.status===1?0:1})}).catch(()=>{t.status=t.status===1?0:1})},O=t=>{D.confirm(`是否确认删除角色 "${t.roleName}"?`,"系统提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ie(t.id).then(()=>{h.success("删除成功"),v()}).catch(e=>{console.error(e)}),v()})},z=t=>{let e=[];return t.forEach(n=>{e.push(n.id),n.children&&n.children.length>0&&(e=e.concat(z(n.children)))}),e},L=async t=>{d.roleId=t.id,d.roleName=t.roleName,d.visible=!0,d.loading=!0;try{const[e,n]=await Promise.all([ve(),re(t.id)]);w.value=e.data;const i=z(n.data);console.log("后端返回的树:",n.data),console.log("拍扁后的ID:",i);const y=T(w.value,i);console.log("叶子节点leafKeys:",y),_e(()=>{V.value.setCheckedKeys(y),d.loading=!1})}catch(e){console.error(e),d.loading=!1}},T=(t,e)=>{console.log("nodes",t),console.log("checkedKeys",e);let n=[];return t.forEach(i=>{i.children&&i.children.length>0?(console.log("有子节点",i.id),n.push(...T(i.children,e))):e.includes(i.id)&&(console.log("是叶子结点",i.id),n.push(i.id))}),n},A=async()=>{d.loading=!0;try{const t=V.value.getCheckedKeys(),e=V.value.getHalfCheckedKeys(),n=[...t,...e];await de({roleId:d.roleId,menuIds:n}),h.success("权限分配成功"),d.visible=!1}catch(t){console.error(t)}finally{d.loading=!1}};return me(()=>{v()}),(t,e)=>{const n=r("el-input"),i=r("el-form-item"),y=r("el-option"),J=r("el-select"),c=r("el-button"),I=r("el-form"),g=r("el-table-column"),Q=r("el-tag"),H=r("el-switch"),G=r("el-table"),W=r("el-pagination"),X=r("el-input-number"),$=r("el-radio"),Y=r("el-radio-group"),Z=r("el-dialog"),ee=r("el-tree"),le=r("el-drawer"),te=pe("loading");return B(),ce("div",ye,[m("div",xe,[m("div",he,[l(I,{inline:!0,model:p,class:"!mb-0"},{default:a(()=>[l(i,{label:"角色名称",class:"!mb-0 mr-4"},{default:a(()=>[l(n,{modelValue:p.roleName,"onUpdate:modelValue":e[0]||(e[0]=o=>p.roleName=o),placeholder:"请输入角色名称",clearable:"","prefix-icon":"Search",class:"w-56"},null,8,["modelValue"])]),_:1}),l(i,{label:"状态",class:"!mb-0 mr-4"},{default:a(()=>[l(J,{modelValue:p.status,"onUpdate:modelValue":e[1]||(e[1]=o=>p.status=o),placeholder:"全部",clearable:"",class:"w-32"},{default:a(()=>[l(y,{label:"启用",value:1}),l(y,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),l(i,{class:"!mb-0"},{default:a(()=>[l(c,{type:"primary",icon:"Search",onClick:k},{default:a(()=>[...e[13]||(e[13]=[u("搜索",-1)])]),_:1}),l(c,{icon:"Refresh",onClick:P},{default:a(()=>[...e[14]||(e[14]=[u("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),m("div",null,[l(c,{type:"primary",plain:"",icon:"Plus",onClick:F},{default:a(()=>[...e[15]||(e[15]=[u("新增角色",-1)])]),_:1})])])]),m("div",Ve,[fe((B(),ge(G,{data:S.value,style:{width:"100%"},"header-cell-style":{background:"#f8f9fa",color:"#606266"},stripe:""},{default:a(()=>[l(g,{prop:"id",label:"ID",width:"80",align:"center"}),l(g,{prop:"roleName",label:"角色名称","min-width":"120","font-weight":"bold"},{default:a(({row:o})=>[m("span",ke,K(o.roleName),1)]),_:1}),l(g,{prop:"roleKey",label:"权限字符","min-width":"120"},{default:a(({row:o})=>[l(Q,{type:"info",effect:"plain"},{default:a(()=>[u(K(o.roleKey),1)]),_:2},1024)]),_:1}),l(g,{prop:"sort",label:"显示顺序",width:"100",align:"center"}),l(g,{label:"状态",width:"100",align:"center"},{default:a(({row:o})=>[l(H,{modelValue:o.status,"onUpdate:modelValue":x=>o.status=x,"active-value":1,"inactive-value":0,"inline-prompt":"","active-text":"启","inactive-text":"停",onChange:x=>q(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(g,{prop:"createTime",label:"创建时间",width:"180",align:"center"}),l(g,{label:"操作",width:"260",fixed:"right",align:"center"},{default:a(({row:o})=>[l(c,{link:"",type:"primary",icon:"Edit",onClick:x=>M(o)},{default:a(()=>[...e[16]||(e[16]=[u("编辑",-1)])]),_:1},8,["onClick"]),l(c,{link:"",type:"success",icon:"Setting",onClick:x=>L(o)},{default:a(()=>[...e[17]||(e[17]=[u("权限",-1)])]),_:1},8,["onClick"]),l(c,{link:"",type:"danger",icon:"Delete",onClick:x=>O(o)},{default:a(()=>[...e[18]||(e[18]=[u("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[te,N.value]]),m("div",Ce,[l(W,{"current-page":p.pageNum,"onUpdate:currentPage":e[2]||(e[2]=o=>p.pageNum=o),"page-size":p.pageSize,"onUpdate:pageSize":e[3]||(e[3]=o=>p.pageSize=o),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:R.value,onSizeChange:k,onCurrentChange:k},null,8,["current-page","page-size","total"])])]),l(Z,{title:f.title,modelValue:f.visible,"onUpdate:modelValue":e[10]||(e[10]=o=>f.visible=o),width:"500px","append-to-body":"","destroy-on-close":""},{footer:a(()=>[m("div",Ne,[l(c,{onClick:e[9]||(e[9]=o=>f.visible=!1)},{default:a(()=>[...e[22]||(e[22]=[u("取 消",-1)])]),_:1}),l(c,{type:"primary",onClick:j},{default:a(()=>[...e[23]||(e[23]=[u("确 定",-1)])]),_:1})])]),default:a(()=>[l(I,{ref_key:"roleFormRef",ref:b,model:s,rules:E,"label-width":"80px"},{default:a(()=>[l(i,{label:"角色名称",prop:"roleName"},{default:a(()=>[l(n,{modelValue:s.roleName,"onUpdate:modelValue":e[4]||(e[4]=o=>s.roleName=o),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),l(i,{label:"权限字符",prop:"roleKey"},{default:a(()=>[l(n,{modelValue:s.roleKey,"onUpdate:modelValue":e[5]||(e[5]=o=>s.roleKey=o),placeholder:"例如：admin"},null,8,["modelValue"]),e[19]||(e[19]=m("div",{class:"text-xs text-gray-400 mt-1"},` 控制器中定义的权限字符，如：@PreAuthorize("hasRole('admin')") `,-1))]),_:1}),l(i,{label:"显示顺序",prop:"sort"},{default:a(()=>[l(X,{modelValue:s.sort,"onUpdate:modelValue":e[6]||(e[6]=o=>s.sort=o),min:0,"controls-position":"right"},null,8,["modelValue"])]),_:1}),l(i,{label:"状态"},{default:a(()=>[l(Y,{modelValue:s.status,"onUpdate:modelValue":e[7]||(e[7]=o=>s.status=o)},{default:a(()=>[l($,{value:1},{default:a(()=>[...e[20]||(e[20]=[u("启用",-1)])]),_:1}),l($,{value:0},{default:a(()=>[...e[21]||(e[21]=[u("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"备注"},{default:a(()=>[l(n,{modelValue:s.remark,"onUpdate:modelValue":e[8]||(e[8]=o=>s.remark=o),type:"textarea",placeholder:"请输入备注内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),l(le,{modelValue:d.visible,"onUpdate:modelValue":e[12]||(e[12]=o=>d.visible=o),title:"分配菜单权限",size:"400px","append-to-body":""},{default:a(()=>[m("div",we,[m("div",Ke,[e[24]||(e[24]=u(" 正在为角色 ",-1)),m("strong",null,K(d.roleName),1),e[25]||(e[25]=u(" 分配权限 ",-1))]),m("div",Re,[l(ee,{ref_key:"menuTreeRef",ref:V,data:w.value,"show-checkbox":"","node-key":"id",props:{label:"label",children:"children"},"default-expand-all":""},null,8,["data"])]),m("div",Se,[l(c,{onClick:e[11]||(e[11]=o=>d.visible=!1)},{default:a(()=>[...e[26]||(e[26]=[u("取消",-1)])]),_:1}),l(c,{type:"primary",loading:d.loading,onClick:A},{default:a(()=>[...e[27]||(e[27]=[u("保存权限",-1)])]),_:1},8,["loading"])])])]),_:1},8,["modelValue"])])}}}),$e=be(Ue,[["__scopeId","data-v-6e60955d"]]);export{$e as default};
