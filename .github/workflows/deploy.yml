name: Deploy to Aliyun
on:
  push:
    branches:
      - master # 或者 main，根据你的分支名修改

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub 的环境非常标准

    steps:
      # 1. 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 关键：设置 Node.js 18 (GitHub 官方插件，秒级安装，绝对成功)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' # 自动缓存依赖，下次构建更快

      # 3. 安装依赖并打包
      - name: Install & Build
        run: |
          node -v  # 这里打印出来绝对是 v18.x.x
          npm install
          npm run build
          ls -la dist/ # 确认打包成功

      # 4. 上传文件到阿里云
      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'dist/*'
          target: '/var/www/html/vue-admin-template/'
          strip_components: 1 # 去掉 dist 这一层目录

      # 5. 重启 Nginx (可选，静态文件通常不需要重启，但为了保险)
      - name: Restart Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo chown -R www-data:www-data /var/www/html/vue-admin-template/
            sudo chmod -R 755 /var/www/html/vue-admin-template/
            # sudo systemctl reload nginx 
            echo "部署完成！"
